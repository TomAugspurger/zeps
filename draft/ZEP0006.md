---
layout: default
title: ZEP0006
description: Consolidated Metadata
parent: draft ZjEPs
nav_order: 4
---

# ZEP 6 â€” Consolidated Metadata

---

Authors:

* Tom Augspurger ([@TomAugspurger](http://github.com/TomAugspurger))

Status: Draft

Type: Specification

Created: 2024-08-18

Discussion: ...

Resolution: ...

Resolution: <url> (required for Accepted | Rejected | Withdrawn)

## Abstract

Consolidated Metadata is a specification for storing Zarr Metadata in a single location. This can speed up the time to access Zarr datasets, especially on high-latency systems like remote Blob Storage services. It extends the `Stored Representation <https://zarr-specs.readthedocs.io/en/latest/v3/core/v3.0.html#stored-representation>`_ of a Zarr hierarchy to consolidate the metadata of all arrays into the top-level `zarr.json`.

The abstract should be a short description of what the ZEP will achieve.

## Motivation and Scope

Zarr datasets are often served from Blob Storage services over HTTP. These are relatively high-latency systems. Reading a single file, even if it's small, can take 100s of milliseconds. In this context, a reader wishing to discover all of the groups and arrays available in a hierarchy would need to

1. List all the files under some prefix (one HTTP request)
2. Open the `zarr.json` for each group or array (one HTTP request per group or array)

For hierarchies with many arrays, this can add up.

Because the `zarr.json` files are typically small, we can consolidate all of them into a single file at the root of the store. With consolidated metadata, a reader needs just a single HTTP request to discover all the groups and arrays in a hierarchy.

## Usage and Impact

This ZEP should have no noticeable effect on users of Zarr, aside from shorting the time it takes to read all the metadata
of a Zarr hierarchy (especially large ones from remote file systems).

## Backward Compatibility

This ZEP should have no incompatibilities with previous versions. Consolidated Metadata should be viewed as purely additive to the default, non-consolidated metadata. Readers that don't support consolidated metadata should still be able to read the existing Zarr hierarchy.

## Detailed description

The root `zarr.json` will be expanded to include the contents of each child `zarr.json`.

| Field                 | Type                         | Description                                 |
|-----------------------|------------------------------|---------------------------------------------|
| consolidated_metadata | Map<string, Metadata object> | A mapping from node key to Metadata objects |

All new objects will be placed under the `consolidated_metadata` field. The keys of the mapping should
be the node key of each node, excluding any leading or trailing `/`s.

For example, a hierarchy with child arrays `air` and `lat` might have an abbreviated `consolidated_metadata` like:

```json
consolidated_metadata: {
    "air": {
        "shape": [2920, 25, 53],
        "fill_value": 0,
        ...
        "node_type": "array",
    },
    "lat": {
        "shape": [25],
        "fill_value": NaN,
        ...
        "node_type": "array",
    }
}
```

## Related Work

Consolidated metadata is implemented in zarr-python 2.x: https://zarr.readthedocs.io/en/stable/tutorial.html#consolidating-metadata
Downstream libraries like xarray include consolidated metadata-related keywords in their [public API](https://docs.xarray.dev/en/latest/generated/xarray.Dataset.to_zarr.html).

## Implementation

Implementations can support consolidated metadata in two ways: reading or writing.

To support reading consolidated metadata, an implementation should check for the presence of the `consolidated_metadata` key in the `zarr.json` object (TODO: is there a better way to indicate that a dataset uses an extension?). Readers can use the metadata present to speed up operations on child nodes in the hierarchy.

To support writing consolidated metadata, implementations can offer an API to consolidate metadata by reading metadata from all child nodes and adding it to the `consolidated_metadata` field of the root node.

## Alternatives

https://github.com/zarr-developers/zarr-specs/issues/284 discusses a partial step to consolidated metadata: storing just the *names* of the child nodes in a central location.

*Not* implementing Consolidated Metadata is also an option. The primary use-case is reducing the time it takes to read Zarr hierarchies with many nodes from remote systems over HTTP. Implementations can also use parallelism and concurrency to achieve the same result.

## Discussion

This section should have links related to any discussion regarding the ZEP. It could be GitHub issues and/or discussions. (The links to discussions in past 
if any, goes in this section.)

## References and Footnotes

Each ZEP must either be explicitly labelled as placed in the public domain (see this ZEP as an example) or licensed under the 
[Open Publication License](https://www.opencontent.org/openpub/).

## Copyright

This document has been placed in the public domain.
